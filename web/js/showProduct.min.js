
$("document").ready(function(){rafraichitDenree();calculTempsTotal();$("#choix_nombre_couverts").on("blur, change",function(){$("#choix_nombre_couverts").attr("disabled","disabled");calculTempsTotal();rafraichitDenree();$("#choix_nombre_couverts").removeAttr("disabled")});$(".cboxElement").on("click",function(a){a.preventDefault();$.ajax({url:$(this).attr("href"),data:{json:1},type:"POST",dataType:"JSON",success:function(c){var b=bootbox.dialog({title:"Informations sur l'AEJ",message:c,size:"large"})}})});$(".etape").on("mouseover",function(){var b=$(this).attr("id");var a=b.split("-");idFinal=a[1];$(this).css("background-color",$(this).attr("data-attr-color"));$('.denree table tbody tr td[id^="denree-'+idFinal+'"]').css("background-color",$(this).attr("data-attr-color"))});$(".etape").on("mouseout",function(){var b=$(this).attr("id");var a=b.split("-");idFinal=a[1];$(this).css("background-color","transparent");$('.denree table tbody tr td[id^="denree-'+idFinal+'"]').css("background-color","transparent")});$("#coefficient").on("dblclick",function(c){if($(c.target).hasClass("editable")){var f=$(this).html();var a=document.createElement("input");a.setAttribute("type","text");a.setAttribute("size","7");a.setAttribute("class","form-control");a.setAttribute("value",f);var d=document.createElement("button");d.setAttribute("type","button");d.setAttribute("class","btn btn-default");d.innerHTML="OK";var b=document.createElement("span");b.setAttribute("class","input-group-btn");var g=document.createElement("div");g.setAttribute("class","input-group");$(d).appendTo(b);$(a).appendTo(g);$(b).appendTo(g);d.onclick=function(){$(this).parent().parent().parent().html($(this).parent().parent().find("input[type=text]").val());calculCoeff()};$(this).html("");$(g).appendTo(this)}})});function rafraichitDenree(){$.ajax({url:basePage+"getByProduit/"+$("#productIdRef").val(),type:"GET",dataType:"JSON",success:function(o){if(o.success){$(".denree table tbody tr").remove();var a=$(".theadEtape").length;for(var j in o.data){$('<tr class="headCategorieDenree"><td colspan="'+(parseInt(a)+5)+'">'+j+"</td></tr>").appendTo(".denree table tbody");for(var k in o.data[j]){if($(".denree table tbody tr td#denree-"+(o.data[j][k].etapeID)+"-"+(o.data[j][k].denreeID)).length==0){var b=document.createElement("tr");b.setAttribute("id","denreeID-"+o.data[j][k].denreeID);b.setAttribute("class","denreeTR");var h=document.createElement("td");h.innerHTML=o.data[j][k].Nom;$(h).appendTo(b);var n=document.createElement("td");n.innerHTML=o.data[j][k].uniteMesure;$(n).appendTo(b);for(var c=1;c<o.data[j][k].etapeOrdre;c++){var m=document.createElement("td");m.setAttribute("id","denree-"+o.etapes[c]+"-"+o.data[j][k].denreeID);$(m).appendTo(b)}var m=document.createElement("td");m.innerHTML=parseFloat(o.data[j][k].quantite*$("#choix_nombre_couverts").val()).toFixed(3);m.setAttribute("id","denree-"+(o.data[j][k].etapeID)+"-"+(o.data[j][k].denreeID));m.setAttribute("class","denreeValue");$(m).appendTo(b);for(var c=o.data[j][k].etapeOrdre+1;c<=a;c++){var m=document.createElement("td");m.setAttribute("id","denree-"+o.etapes[c]+"-"+o.data[j][k].denreeID);$(m).appendTo(b)}var g=document.createElement("td");g.setAttribute("class","totalQtt");var l=document.createElement("td");l.innerHTML=o.data[j][k].pUHT;l.setAttribute("class","puhtdenree editable");var f=document.createElement("td");$(g).appendTo(b);$(l).appendTo(b);$(f).appendTo(b);$(b).appendTo(".denree table tbody")}else{$(".denree table tbody tr td#denree-"+(o.data[j][k].etapeID)+"-"+(o.data[j][k].denreeID)).html(parseFloat(o.data[j][k].quantite*$("#choix_nombre_couverts").val()).toFixed(3));$(".denree table tbody tr td#denree-"+(o.data[j][k].etapeID)+"-"+(o.data[j][k].denreeID)).attr("class","denreeValue")}}}calculColonne();$(".puhtdenree").on("dblclick",function(p){if($(p.target).hasClass("editable")){var r=$(this).html();var d=document.createElement("input");d.setAttribute("type","text");d.setAttribute("size","7");d.setAttribute("class","form-control");d.setAttribute("value",r);var q=document.createElement("button");q.setAttribute("type","button");q.setAttribute("class","btn btn-default");q.innerHTML="OK";var i=document.createElement("span");i.setAttribute("class","input-group-btn");var s=document.createElement("div");s.setAttribute("class","input-group");$(q).appendTo(i);$(d).appendTo(s);$(i).appendTo(s);q.onclick=function(){$(this).parent().parent().parent().html($(this).parent().parent().find("input[type=text]").val());calculColonne()};$(this).html("");$(s).appendTo(this)}})}else{bootbox.alert("<div class='alert alert-danger'>Une erreur est survenue lors de la récupération des denrees</div>")}}})}function calculColonne(){var a=$(".denree table tbody tr.denreeTR");var f=0;$(".denree table tbody tr.denreeTR").each(function(g){var i=0;$(this).find("td.denreeValue").each(function(j){i=parseFloat($(this).text())+parseFloat(i)});$(this).find("td.totalQtt").html(i.toFixed(3));var h=parseFloat($(this).find("td:last-child").prev().html());$(this).find("td:last-child").html(parseFloat(h*i.toFixed(3)).toFixed(2));$(this).find("td:last-child").attr("class","ptht");f=parseFloat(parseFloat(h*i.toFixed(3)).toFixed(2))+parseFloat(f)});var e=parseFloat(f).toFixed(2);var d=parseFloat((parseFloat(f).toFixed(2)*2)/100).toFixed(2);$(".denree table tfoot td#totDenree").html(e);$("span#prix_total").html(parseFloat(parseFloat(d)+parseFloat(e)).toFixed(2));$(".denree table tfoot td#assaiso").html(d);$(".denree table tfoot td#totMatiere").html(parseFloat(parseFloat(d)+parseFloat(e)).toFixed(2));var c=parseFloat(parseFloat(d)+parseFloat(e)).toFixed(2);var b=parseFloat(c)*parseFloat($("#coefficient").html());$("span#prix_portion").html(parseFloat(b/parseFloat($("#choix_nombre_couverts").val())).toFixed(2))}function calculCoeff(){var b=parseFloat($("#prix_total").html()).toFixed(2);var a=parseFloat(b)*parseFloat($("#coefficient").html());$("span#prix_portion").html(parseFloat(a/parseFloat($("#choix_nombre_couverts").val())).toFixed(2))}function calculTempsTotal(){var b=$("input.detailDataTemps").toArray();var d=0;for(var c=0;c<b.length;c++){if($(b[c]).attr("data-attr-unite")=="h"){if($(b[c]).attr("data-attr-calculType")=="unitaire"){d+=parseInt($(b[c]).val())*60*60*parseInt($("#choix_nombre_couverts").val())}else{d+=parseInt($(b[c]).val())*60*60}}else{if($(b[c]).attr("data-attr-unite")=="m"){if($(b[c]).attr("data-attr-calculType")=="unitaire"){d+=parseInt($(b[c]).val())*60*parseInt($("#choix_nombre_couverts").val())}else{d+=parseInt($(b[c]).val())*60}}else{if($(b[c]).attr("data-attr-calculType")=="unitaire"){d+=parseInt($(b[c]).val())*parseInt($("#choix_nombre_couverts").val())}else{d+=parseInt($(b[c]).val())}}}}var a=dateHMS(d);$("#calculTemps span").html((parseInt(a[0])-1)+"J "+a[1]+"h "+a[2]+"m "+a[3]+"s")}function dateHMS(a){var b=moment().startOf("year").seconds(a).format("DDD:HH:mm:ss");return b.split(":")};