$('document').ready(function(){    rafraichitDenree();    calculTempsTotal();    $('#choix_nombre_couverts').on("blur, change",function(){        $("#choix_nombre_couverts").attr("disabled","disabled");        calculTempsTotal();        rafraichitDenree();         $("#choix_nombre_couverts").removeAttr("disabled");    });    $('.cboxElement').on("click",function(evt){        evt.preventDefault();               $.ajax({            url: $(this).attr("href"),            data:{json:1},            type: 'POST',            dataType: 'JSON',            success: function(retour) {                var dialog = bootbox.dialog({                    title: 'Informations sur l\'AEJ',                    message: retour,                    size: 'large'                });            }       });           });    $('.etape').on("mouseover",function(){       var id = $(this).attr("id");       var decoupeId=id.split("-");       idFinal = decoupeId[1];//       alert(idFinal);       $(this).css("background-color",$(this).attr("data-attr-color"));       $(".denree table tbody tr td[id^=\"denree-"+idFinal+"\"]").css("background-color",$(this).attr("data-attr-color"));    });    $('.etape').on("mouseout",function(){       var id = $(this).attr("id");       var decoupeId=id.split("-");       idFinal = decoupeId[1];       $(this).css("background-color","transparent");       $(".denree table tbody tr td[id^=\"denree-"+idFinal+"\"]").css("background-color","transparent");    });    $('#coefficient').on("dblclick",function(e){        if($(e.target).hasClass("editable")){            var val=$(this).html();            var input = document.createElement("input");            input.setAttribute("type","text");            input.setAttribute("size","7");            input.setAttribute("class","form-control");            input.setAttribute("value",val);            var bouton = document.createElement("button");            bouton.setAttribute("type","button");            bouton.setAttribute("class","btn btn-default");            bouton.innerHTML="OK";            var span = document.createElement("span");            span.setAttribute("class","input-group-btn");            var div = document.createElement("div");            div.setAttribute("class","input-group");            $(bouton).appendTo(span);            $(input).appendTo(div);            $(span).appendTo(div);            bouton.onclick=function(){                $(this).parent().parent().parent().html($(this).parent().parent().find("input[type=text]").val());                calculCoeff();            };            $(this).html("");            $(div).appendTo(this);        }    });});function rafraichitDenree(){    $.ajax({        url: basePage+'getByProduit/'+$('#productIdRef').val(),        type: 'GET',        dataType: 'JSON',        success: function(json) {            if(json.success){                $('.denree table tbody tr').remove();                var nbEtape = $('.theadEtape').length;                for(var e in json.data){                                        $('<tr class="headCategorieDenree"><td colspan="'+(parseInt(nbEtape)+5)+'">'+e+'</td></tr>').appendTo('.denree table tbody');                                        for(var d in json.data[e]){                                                if($('.denree table tbody tr td#denree-'+(json.data[e][d].etapeID)+'-'+(json.data[e][d].denreeID)).length==0){                                                        var newTR = document.createElement("tr");                            newTR.setAttribute("id","denreeID-"+json.data[e][d].denreeID);                            newTR.setAttribute("class","denreeTR");                                                        var newTDLabel = document.createElement("td");                            newTDLabel.innerHTML = json.data[e][d].Nom;                            $(newTDLabel).appendTo(newTR);                                                        var newTDuniteMesure = document.createElement("td");                            newTDuniteMesure.innerHTML = json.data[e][d].uniteMesure;                            $(newTDuniteMesure).appendTo(newTR);                                                        //Creation des colonnes pouvant précèder l'étape en cours                            for(var i = 1 ; i<json.data[e][d].etapeOrdre; i++){                                var newTD = document.createElement("td");                                newTD.setAttribute("id","denree-"+json.etapes[i]+'-'+json.data[e][d].denreeID);                                $(newTD).appendTo(newTR);                            }                            var newTD = document.createElement("td");                            newTD.innerHTML = parseFloat(json.data[e][d].quantite*$('#choix_nombre_couverts').val()).toFixed(3);                            newTD.setAttribute("id","denree-"+(json.data[e][d].etapeID)+'-'+(json.data[e][d].denreeID));                            newTD.setAttribute("class","denreeValue");                            $(newTD).appendTo(newTR);                                                        // Création des colonnes restantes de l'étape en cours                            for(var i = json.data[e][d].etapeOrdre+1 ; i<=nbEtape; i++){                                var newTD = document.createElement("td");                                newTD.setAttribute("id","denree-"+json.etapes[i]+'-'+json.data[e][d].denreeID);                                $(newTD).appendTo(newTR);                            }                                                        var newTDTotal = document.createElement("td");                            newTDTotal.setAttribute("class","totalQtt");                            var newTDPUHT = document.createElement("td");                            newTDPUHT.innerHTML=json.data[e][d].pUHT;                            newTDPUHT.setAttribute("class","puhtdenree editable");                                                        var newTDPTHT = document.createElement("td");                            $(newTDTotal).appendTo(newTR);                            $(newTDPUHT).appendTo(newTR);                            $(newTDPTHT).appendTo(newTR);                            $(newTR).appendTo('.denree table tbody');                        }                        else{                            $('.denree table tbody tr td#denree-'+(json.data[e][d].etapeID)+'-'+(json.data[e][d].denreeID)).html(parseFloat(json.data[e][d].quantite*$('#choix_nombre_couverts').val()).toFixed(3));                            $('.denree table tbody tr td#denree-'+(json.data[e][d].etapeID)+'-'+(json.data[e][d].denreeID)).attr("class","denreeValue");                        }                    }                }                calculColonne();                $('.puhtdenree').on("dblclick",function(e){                    if($(e.target).hasClass("editable")){                        var val=$(this).html();                        var input = document.createElement("input");                        input.setAttribute("type","text");                        input.setAttribute("size","7");                        input.setAttribute("class","form-control");                        input.setAttribute("value",val);                        var bouton = document.createElement("button");                        bouton.setAttribute("type","button");                        bouton.setAttribute("class","btn btn-default");                        bouton.innerHTML="OK";                        var span = document.createElement("span");                        span.setAttribute("class","input-group-btn");                        var div = document.createElement("div");                        div.setAttribute("class","input-group");                        $(bouton).appendTo(span);                        $(input).appendTo(div);                        $(span).appendTo(div);                        bouton.onclick=function(){                            $(this).parent().parent().parent().html($(this).parent().parent().find("input[type=text]").val());                            calculColonne();                        };                        $(this).html("");                        $(div).appendTo(this);                    }                });            }            else{                bootbox.alert("<div class='alert alert-danger'>Une erreur est survenue lors de la récupération des denrees</div>");            }        }    });}function calculColonne(){    var trs = $('.denree table tbody tr.denreeTR');    var totalGlobalPTHT=0;    $('.denree table tbody tr.denreeTR').each(function( index ) {        var total=0;        $(this).find("td.denreeValue").each(function( i ) {            total=parseFloat($(this).text())+parseFloat(total);        });        $(this).find("td.totalQtt").html(total.toFixed(3));        var prixUHT = parseFloat($(this).find("td:last-child").prev().html());        $(this).find("td:last-child").html(parseFloat(prixUHT*total.toFixed(3)).toFixed(2));        $(this).find("td:last-child").attr("class","ptht");        totalGlobalPTHT=parseFloat(parseFloat(prixUHT*total.toFixed(3)).toFixed(2))+parseFloat(totalGlobalPTHT);    });    var totDenree=parseFloat(totalGlobalPTHT).toFixed(2);    var assaiso=parseFloat((parseFloat(totalGlobalPTHT).toFixed(2)*2)/100).toFixed(2);    $(".denree table tfoot td#totDenree").html(totDenree);    $("span#prix_total").html(parseFloat(parseFloat(assaiso)+parseFloat(totDenree)).toFixed(2));    $(".denree table tfoot td#assaiso").html(assaiso);    $(".denree table tfoot td#totMatiere").html(parseFloat(parseFloat(assaiso)+parseFloat(totDenree)).toFixed(2));        var totalMatiere = parseFloat(parseFloat(assaiso)+parseFloat(totDenree)).toFixed(2);    var PrixPortion = parseFloat(totalMatiere)*parseFloat($('#coefficient').html());    $("span#prix_portion").html(parseFloat(PrixPortion/parseFloat($('#choix_nombre_couverts').val())).toFixed(2));        }function calculCoeff(){    var totalMatiere = parseFloat($('#prix_total').html()).toFixed(2);    var PrixPortion = parseFloat(totalMatiere)*parseFloat($('#coefficient').html());    $("span#prix_portion").html(parseFloat(PrixPortion/parseFloat($('#choix_nombre_couverts').val())).toFixed(2));}function calculTempsTotal(){    var inputTemps = $('input.detailDataTemps').toArray();    var tempsTotalSeconde = 0;    for ( var i = 0; i < inputTemps.length; i++ ) {        if($(inputTemps[ i ]).attr("data-attr-unite")=="h"){            if($(inputTemps[ i ]).attr("data-attr-calculType")=="unitaire") tempsTotalSeconde+=parseInt($(inputTemps[ i ]).val())*60*60*parseInt($("#choix_nombre_couverts").val());            else tempsTotalSeconde+=parseInt($(inputTemps[ i ]).val())*60*60;                    }        else if($(inputTemps[ i ]).attr("data-attr-unite")=="m"){            if($(inputTemps[ i ]).attr("data-attr-calculType")=="unitaire") tempsTotalSeconde+=parseInt($(inputTemps[ i ]).val())*60*parseInt($("#choix_nombre_couverts").val());            else tempsTotalSeconde+=parseInt($(inputTemps[ i ]).val())*60;        }        else{            if($(inputTemps[ i ]).attr("data-attr-calculType")=="unitaire") tempsTotalSeconde+=parseInt($(inputTemps[ i ]).val())*parseInt($("#choix_nombre_couverts").val());            else tempsTotalSeconde+=parseInt($(inputTemps[ i ]).val());        }    }    var stoH = dateHMS(tempsTotalSeconde);    $('#calculTemps span').html((parseInt(stoH[0])-1)+'J '+stoH[1]+'h '+stoH[2]+'m '+stoH[3]+'s');}function dateHMS(time) {  var d = moment().startOf('year').seconds(time).format('DDD:HH:mm:ss');  return d.split(':');}